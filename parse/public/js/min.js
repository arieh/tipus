function init(){$("form.login").remove(),$("form.add-user-form").modal("show"),Data.fetchAll(function(){$("nav.main").css("display","block")})}var Data={};Data.types=["Category","Climber","Stage"],Data.models={},Data.collections={},Data.types.forEach(function(t){Data.models[t]=Parse.Object.extend(t,{handle:null,initialize:function(){Data.collections[t].add(this)},save:function(){clearTimeout(this.handle),this.handle=setTimeout(function(t){Parse.Object.prototype.save.apply(this,t)}.bind(this,arguments),500)}}),Data.collections[t]=new(Parse.Collection.extend({model:Data.models[t]}))}),Data.fetchAll=function(t){function e(){return i=Data.types[a],a++,n?void 0:i?void Data.collections[i].fetch().then(e):(t(),void(n=!0))}var i,a=0,n=!1;e()},Data.create=function(t,e){var i=new Data.models[t](e);i.save()};var Names={getSingular:function(t){return dictionary.singular[t]},getPlural:function(t){return dictionary.plural[t]}},Page={types:{},show:function(t){this.active_el&&el[0].removeChild(this.active_el),this.active_el=t.$el[0],el.append(this.active_el)}},el=$("section.main"),Stage={};Stage.Query=function(t,e){var i=new Parse.Query("Climber");i.equalTo("category",t),i.find().then(e)},Stage.Perliminary=Backbone.View.extend({templates:{main:_.template('<section><h1><%=title%></h1>            <button class="sort-name"><%=sort_name%></button><button class="sort-rank"><%=sort_rank%></button>            <table class="table"><thead><tr>                <th><%= name %></th><th><%= id_num %></th><th><%=age%></th><th><%=home%></th><%= routes %><th><%= score %></th>            </tr></thead><tbody></tbody></table></section>'),route_header:_.template("<th class='route'>"+dictionary.Climber.route+" <%= num %></th>"),climber:_.template("<td><%= name %></td><td><%= id_num %></td><td><%=calc_age%></td><td><%=home%></td><%= routes %><td class='score'><%=perliminary_score%></td>"),climber_route:_.template('<td class="route"><input data-index="<%=num%>" data-climber="<%=climber%>" value="<%=value%>" /></td>')},events:{"keyup .route input":"routeChange","click .sort-name":"sortByName","click .sort-rank":"sortByRank"},initialize:function(t){for(this.category=t.category,this.route_num=t.route_number||5,this.routes=[],this.climbers={},this.scores={},this.title=t.title,i=0;i<this.route_num;i++)this.routes[i]={climbers:{},ranked:[]};this.render(),Stage.Query(this.category,this.populate.bind(this))},render:function(){var t,e=($("<tr>"),"");for(t=0;t<this.route_num;t++)e+=this.templates.route_header({num:t+1});var i=_.clone(dictionary.Perliminary);i.routes=e,i.title=i.title+" : "+this.title,this.$el=$(this.templates.main(i)),this.el=this.$el[0]},populate:function(t){this.models=_.clone(t),this.models.forEach(this.createItem.bind(this)),this.routes.forEach(function(t,e){this.rankRoute(e)}.bind(this));for(var e in this.climbers)this.updateClimberScore(e);this.sortByName()},createItem:function(t,e){for(var i=$("<tr></tr>",{"data-index":e,"data-id":t.id}),a="",n=t.get("routes")||[],s=0;s<this.route_num;s++)a+=this.templates.climber_route({num:s,climber:t.id,value:n[s]||""}),this.routes[s].climbers[t.id]={score:n[s]||"",rank:0},this.routes[s].ranked.push(t.id);var r=_.clone(t.attributes);r.routes=a,r.perliminary_score||(r.perliminary_score=r.score||0),r.home||(r.home=""),r.calc_age=(new Date).getFullYear()-r.age,i.html(this.templates.climber(r)),this.climbers[t.id]=t,this.$("tbody").append(i)},routeChange:function(t){var e=$(t.target),i=e.attr("data-climber"),a=this.climbers[i],n=e.attr("data-index"),s=this.routes[n];s.climbers[i].score=e.val();var r=a.get("routes")||new Array(this.route_num);r[n]=e.val(),a.set("routes",r).save(),this.rankRoute(n);for(i in this.climbers)this.updateClimberScore(i)},rankRoute:function(t){function e(t){return t*((t+1)/2)}function i(t,i){var a,n=e(i)-e(t-1);n/=i-t+1;for(var s=t-1;i-1>=s;s++)a=r.ranked[s],o[a].rank=n}var a,n,s,r=this.routes[t],o=r.climbers,l=0;for(r.ranked=r.ranked.sort(function(t,e){var i=o[t].score||0,a=o[e].score||0;return i>a?-1:a>i?1:0}),a=0;n=r.ranked[a];a++)climber=r.climbers[n],s=r.climbers[r.ranked[a+1]],s?s.score!=climber.score&&(i(l+1,a+1),l=a+1):i(l+1,a+1);for(n in this.climbers)this.scores[n]||(this.scores[n]=new Array(this.route_num)),this.scores[n][t]=o[n].rank},updateClimberScore:function(t){function e(t){var e=1;return t.forEach(function(t){e*=t||0}),Math.pow(e,1/t.length)}var i,a=this.$("[data-id="+t+"] .score"),n=this.climbers[t];i=e(this.scores[t]),i=+parseFloat(i).toFixed(3),n.set("perliminary_score",i),n.save(),a.html(i)},sort:function(t){var e=this.$("tbody"),i=[].slice.call(e[0].children);e.html(""),i=i.sort(function(e,i){var a=e.getAttribute("data-id"),n=i.getAttribute("data-id"),s=this.climbers[a],r=this.climbers[n];return t(s,r)}.bind(this)),e.append(i)},sortByName:function(){this.sort(function(t,e){var i=t.attributes.name,a=e.attributes.name;return i>a?1:a>i?-1:0})},sortByRank:function(){this.sort(function(t,e){var i=t.attributes.perliminary_score,a=e.attributes.perliminary_score;return i>a?1:a>i?-1:0})}}),Stage.PerliminarySort=function(t,e,i){function a(e){return t[e]?t[e].attributes.perliminary_score:-1}var t=_.clone(t).sort(function(t,e){var t=t.attributes.perliminary_score||0,e=e.attributes.perliminary_score||0;return t-e});for(e||(e=0),i||(i=t.length-1);a(e)===a(e-1);)e++,i++;for(;a(i)===a(i+1);)i++;return t.slice(e,i)},Stage.SemiFinals=Backbone.View.extend({templates:{main:_.template('<section><h1><%=title%></h1><button class="sort-name"><%=sort_name%></button><button class="sort-rank"><%=sort_rank%></button><button class="sort-order"><%=sort_order%></button><table class="table"><thead><tr><th><%= name %></th><th><%= id_num %></th><th><%=age%></th><th><%=home%></th><th><%=score%></th><th><%=time%></th></tr></thead><tbody></tbody></table></section>'),climber:_.template('<tr data-id="<%=climber%>"><td><%= name %></td><td><%= id_num %></td><td><%=calc_age%></td><td><%=home%></td><td><input type="number"  name="score" data-climber="<%=climber%>" value="<%=score%>" /></td><td><input type="number" name="time" data-climber="<%=climber%>" value="<%=time%>" /></td></tr>')},dict_key:"SemiFinals",score_attr:"semi_score",time_attr:"semi_time",defaults:{start:0,end:10,title:"",category:null},events:{"keyup [name=score]":"scoreChange","keyup [name=time]":"timeChange","click .sort-name":"sortByName","click .sort-order":"sortByOrder","click .sort-rank":"sortByRank"},initialize:function(t){this.options=_.extend({},this.defaults,t),this.models={},this.render(),Stage.Query(this.options.category,this.populate.bind(this))},render:function(){var t=_.clone(dictionary[this.dict_key]);t.title=this.options.title,this.$el=$(this.templates.main(t)),this.el=this.$el[0]},populate:function(t){var t=Stage.PerliminarySort(t,this.options.start,this.options.end);t=_.clone(t),t.forEach(this.createItem.bind(this)),this.sortByName()},getData:function(t){var e=_.clone(t.attributes);return e.score=e[this.score_attr]||0,e.time=e[this.time_attr]||0,e.climber=t.id,e.home=e.home||"",e.calc_age=(new Date).getFullYear()-e.age,e},createItem:function(t){var e=this.getData(t);this.models[t.id]=t,this.$("tbody").append($(this.templates.climber(e)))},scoreChange:function(t){var e=$(t.target),i=e.val(),a=e.attr("data-climber"),n=this.models[a];n.set(this.score_attr,i).save()},timeChange:function(t){var e=$(t.target),i=e.val(),a=e.attr("data-climber"),n=this.models[a];n.set(this.time_attr,i).save()},sort:function(t){var e=this.$("tbody"),i=[].slice.call(e[0].children);e.html(""),i=i.sort(function(e,i){var a=e.getAttribute("data-id"),n=i.getAttribute("data-id"),s=this.models[a],r=this.models[n];return t(s,r)}.bind(this)),e.append(i)},sortByName:function(){this.sort(function(t,e){var i=t.attributes.name,a=e.attributes.name;return i>a?1:a>i?-1:0})},sortByRank:function(){this.sort(function(t,e){return Stage.normalSortFn(t,e,this.score_attr,this.time_attr)}.bind(this))},sortByOrder:function(){this.sortByName(),this.sort(function(t,e){var i=t.attributes.perliminary_score,a=e.attributes.perliminary_score;return a-i}.bind(this))}}),Stage.Finals=Stage.SemiFinals.extend({dict_key:"Finals",score_attr:"final_score",time_attr:"final_time",populate:function(t){var t=Stage.NormalSort(t,"semi_score","semi_time");t=t.slice(this.options.start,this.options.end),t.forEach(this.createItem.bind(this)),this.sortByName()},sortByOrder:function(){this.sortByName(),this.sort(function(t,e){return-1*Stage.normalSortFn(t,e,"semi_score","semi_time")}.bind(this))}}),Stage.normalSortFn=function(t,e,i,a){var n={score:t.attributes[i]||0,time:t.attributes[a]||9999,perliminary:t.attributes.perliminary_score},s={score:e.attributes[i]||0,time:e.attributes[a]||9999,perliminary:e.attributes.perliminary_score};return n.score<s.score?1:n.score>s.score?-1:n.perliminary<s.perliminary?1:n.perliminary>s.perliminary?-1:n.time>s.time?1:-1},Stage.NormalSort=function(t,e,i){var t=_.clone(t).sort(function(t,a){return Stage.normalSortFn(t,a,e,i)});return t};var Views={SelectView:Backbone.View.extend({template:_.template($("#select-template").text()),initialize:function(t){this.collection=t.collection,this.models=t.collection.models,this.render(t),this.setCurrent(t.value||this.models[0].id)},render:function(){var t=this.$el;this.$el=$(this.template({models:this.models})),this.el=this.$el[0],this.$el.on("change",this.optionsChange.bind(this)),t&&t.append(this.$el)},setCurrent:function(t){"string"!=typeof t&&"id"in t&&(t=t.id),this.current&&this.current.attr("current",""),this.current=this.$("[value="+t+"]"),this.current.attr("selected","selected"),this.model=this.collection.filter(function(e){return e.id==t})[0]},optionsChange:function(t){var e=t.target.value;this.setCurrent(e),this.trigger("change",this.val())},val:function(){return this.model}}),List:Backbone.View.extend({templates:{main:_.template("<secion class='page <%=type%>'><header></header><ul class=list></ul></section>")},initialize:function(){this.collection=Data.collections[this.type],this.collection.on("add",this.add.bind(this)),this.models=this.collection.models,this.sort(),this.render(),this.collection.models.forEach(this.add.bind(this))},getTemplateData:function(){return{type:this.type.toLowerCase()}},render:function(){this.$el=$(this.templates.main(this.getTemplateData())),this.elements={header:this.$("header"),list:this.$(".list"),button:$("<button></button>",{html:dictionary[this.type].add,"class":"button"}),form:$("."+this.type.toLowerCase()+"-add-form")},this.elements.header.append($("<h1></h1>",{html:Names.getPlural(this.type)})),this.elements.header.append(this.elements.button),this.elements.button.on("click",function(){this.elements.form.modal("show")}.bind(this)),$(".btn-primary",this.elements.form).on("click",this.create.bind(this))},default_data:{},create:function(){var t=this.getData();Data.create(this.type,t)},getData:function(){var t=_.clone(this.default_data);return this.elements.form.serializeArray().forEach(function(e){return e.value?e.value==+e.value?void(t[e.name]=+e.value):void(t[e.name]=e.value):void 0}),t},add:function(t){if(t.get("name")){var e=new this.subView({model:t});this.elements.list.append(e.$el)}},sort:function(){this.models.sort(function(t,e){var i=t.attributes.name,a=e.attributes.name;return i>a?1:a>i?-1:0})}})},Category=Backbone.View.extend({model:Data.models.Category,template:_.template("<li><header><h3><%=name%></h3></header><nav></nav></li>"),initialize:function(){this.render()},render:function(){this.$el=$('<section class="category"></section>'),this.$el.html(this.template(this.model.attributes)),this.elements={button:$("<button></button>",{html:dictionary.Category.start,"class":"button"})},this.generateStages()},start:function(){this.model.set("started",!0).save(),this.elements.button.hide(),this.generateStages(),this.openPerliminary()},events:{"click .perliminary":"openPerliminary","click .semi":"openSemi","click .semi1":"openSemi1","click .semi2":"openSemi2","click .final":"openFinal","click .final1":"openFinal1","click .final2":"openFinal2"},generate:function(t){var e=$("<button></button>",{html:dictionary.Category[t],"class":t}),i=this.$("nav");t=t[0].toUpperCase()+t.substr(1);var a=this["open"+t]||function(){console.log(t)};e.on("click",a.bind(this)),i.append(e)},generateSemiButtons:function(){2==this.model.get("semi_final_count")?(this.generate("semi1"),this.generate("semi2")):this.generate("semi")},generateFinalButtons:function(){2==this.model.get("semi_final_count")?(this.generate("final1"),this.generate("final2")):this.generate("final")},generateStages:function(){this.generate("perliminary"),this.generateSemiButtons(),this.generateFinalButtons()},openPerliminary:function(){return this.stage?void Page.show(this.stage):(this.stage=new Stage.Perliminary({category:this.model,title:this.model.get("name")}),void Page.show(this.stage))},openSemi:function(t){var e=0,i=this.model.get("semi_finals_climbers"),a=dictionary.Category[t?"semi1":"semi"]+" : "+this.model.get("name");Page.show(new Stage.SemiFinals({start:e,end:i,title:a,category:this.model}))},openSemi1:function(){return this.openSemi(!0)},openSemi2:function(){var t=this.model.get("semi_finals_climbers")+1,e=2*t,i=dictionary.Category.semi2+" : "+this.model.get("name");Page.show(new Stage.SemiFinals({start:t,end:e,title:i,category:this.model}))},openFinal:function(t){var e=0,i=this.model.get("finals_climbers"),a=dictionary.Category[t?"final1":"final"]+" : "+this.model.get("name");Page.show(new Stage.Finals({start:e,end:i,title:a,category:this.model}))},openFinal1:function(){return this.openFinal(!0)},openFinal2:function(){var t=this.model.get("finals_climbers")+1,e=2*t,i=dictionary.Category.final2+" : "+this.model.get("name");Page.show(new Stage.SemiFinals({start:t,end:e,title:i,category:this.model}))}}),CategoryList=Views.List.extend({default_data:{finals_climbers:5,semi_finals_climbers:10},type:"Category",subView:Category}),Climber=Backbone.View.extend({templates:{main:_.template('<tr>            <td><input name="name" value="<%=name%>"/></td>            <td><input name="id_num" value="<%=id_num%>"/></td>            <td><input name="email" value="<%=email%>"/></td>            <td><input name="age" value="<%=age%>" /></td>            <td><input name="home" value="<%=home%>" /></td>            <td class="cat"></td>            </tr>')},events:{"keyup input":"valueChange"},initialize:function(){this.render(),this.select=new Views.SelectView({collection:Data.collections.Category,el:this.$(".cat"),value:this.model.get("category")}),this.select.on("change",this.selectChange.bind(this))},render:function(){var t=_.clone(this.model.attributes);Object.keys(dictionary.Climber).forEach(function(e){e in t||(t[e]="")}),t.real_age=(new Date).getFullYear()-t.age,this.$el=$(this.templates.main(t))},valueChange:function(t){var e=$(t.target),i=e.val(),a=e.attr("name");+i==i&&(i=+i),this.model.set(a,i).save()},selectChange:function(t){this.model.set("category",t).save()}}),ClimberList=Views.List.extend({templates:{main:_.template("<secion class='page climber'><header></header>                        <table class='tabel'><thead>                        <th><%=name%></th><th><%=id_num%></th><th><%=email%></th><th><%=birth_year%></th><th><%=home%></th><th><%=cat%></th>                        </thead><tbody class='list'></tbody></table>                     </section>")},default_data:{id_num:0,email:"",age:0,home:""},type:"Climber",subView:Climber,initialize:function(){ClimberList.__super__.initialize.apply(this,arguments),this.select=new Views.SelectView({collection:Data.collections.Category,el:$(".cat",this.elements.form)})},getTemplateData:function(){var t=_.clone(dictionary.Climber);return t},getData:function(){var t=ClimberList.__super__.getData.apply(this);return t.category=this.select.val(),t}}),nav=$("nav.main"),Nav={classes:{Category:CategoryList,Climber:ClimberList},attach:function(){nav.on("click",function(t){{var e=t.target.getAttribute("data-class");this.classes[e]}this[e]||(this[e]=new this.classes[e]),Page.show(this[e])}.bind(this))}};Nav.attach(),Parse.initialize("SQa6ZzYOcMMIO9uDvvkcxUksxcoBztIbvBgiHZVt","WVrICdMNw7S96fY1FSxYwxUQq24ucMcw5YpyWm1i"),Parse.User.current()?init():$("form.login").modal("show"),$("form.login .submit").on("click",function(){{var t=$(".login .user").val(),e=$(".login .pass").val();Parse.User.logIn(t,e,{success:init})}});